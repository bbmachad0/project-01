# ─── CI - Continuous Integration ──────────────────────────────────
# Runs on pushes and pull requests, but ONLY when relevant files change.
# Reads all config from setup/domain.json - no hardcoded project names.

name: CI

on:
  push:
    branches: ["*"]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - "docs/**"
  pull_request:
    branches: [dev, int, main]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - "docs/**"

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  TERRAFORM_VERSION: "1.14.5"

jobs:
  # ── Detect what changed ──────────────────────────────────────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      jobs: ${{ steps.filter.outputs.jobs }}
      infra: ${{ steps.filter.outputs.infra }}
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Path filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36  # v3
        id: filter
        with:
          filters: |
            core:
              - 'src/core/**'
              - 'pyproject.toml'
              - 'tests/**'
            jobs:
              - 'src/jobs/**'
            infra:
              - 'infrastructure/**'
              - 'setup/domain.json'

  # ── Lint & Test (only when Python code changed) ──────────────────
  test:
    name: Lint & Unit Tests
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.jobs == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run linters
        run: |
          ruff check src/ tests/
          ruff format --check src/ tests/

      - name: Run unit tests
        id: pytest
        run: |
          mkdir -p reports
          pytest tests/ -v --tb=short --junitxml=reports/junit.xml

      - name: Publish test results
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637  # v1
        if: always() && steps.pytest.outcome != 'skipped'
        with:
          name: Unit Tests
          path: reports/junit.xml
          reporter: java-junit
          fail-on-error: false

      - name: Upload test report
        if: always() && steps.pytest.outcome != 'skipped'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: test-results
          path: reports/junit.xml

  # ── Build Wheel (only when core library changed) ────────────────
  build:
    name: Build Wheel
    needs: [changes, test]
    if: needs.changes.outputs.core == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build wheel
        run: |
          pip install build
          python -m build --wheel --outdir dist/

      - name: Upload wheel artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: wheel
          path: dist/*.whl

  # ── Terraform Validate (only when infra changed) ────────────────
  terraform-validate:
    name: Terraform Validate
    needs: changes
    if: needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [dev, int, prod]
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init (no backend)
        working-directory: infrastructure/environments/${{ matrix.environment }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: infrastructure/environments/${{ matrix.environment }}
        run: terraform validate

      - name: Terraform Format Check
        working-directory: infrastructure/environments/${{ matrix.environment }}
        run: terraform fmt -check -recursive

  # ── Terraform Validate Projects (only when infra changed) ───────
  terraform-validate-projects:
    name: Terraform Validate Projects
    needs: changes
    if: needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Validate all project stacks
        run: |
          PROJECTS=$(find infrastructure/projects -maxdepth 2 -name 'project.json' \
            ! -path '*/_template/*' | xargs -I{} dirname {})
          FAILED=0
          for DIR in $PROJECTS; do
            echo "──── Validating $(basename $DIR) ────"
            terraform -chdir="$DIR" init -backend=false -input=false > /dev/null 2>&1
            if ! terraform -chdir="$DIR" validate; then
              FAILED=1
            fi
          done
          exit $FAILED

  # ── Security Scan (SAST + SCA) ──────────────────────────────────
  # Runs when Python code or infrastructure files change.
  # - pip-audit : CVE scan of Python dependencies (SCA)
  # - bandit    : Python SAST (injections, hardcoded secrets, etc.)
  # - checkov   : Terraform / Dockerfile IaC misconfiguration scanner
  security-scan:
    name: Security Scan
    needs: changes
    if: |
      needs.changes.outputs.core == 'true'  ||
      needs.changes.outputs.jobs == 'true'  ||
      needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      - name: Setup Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install security tools
        run: pip install --quiet pip-audit bandit checkov

      # ─ SCA: Python dependency CVE scan ───────────────────────────
      - name: Install project dependencies
        if: needs.changes.outputs.core == 'true'
        run: pip install --quiet -e '.[dev]'

      - name: pip-audit (dependency CVE scan)
        if: needs.changes.outputs.core == 'true'
        run: pip-audit

      # ─ SBOM: Software Bill of Materials ──────────────────────────
      - name: Generate SBOM
        if: needs.changes.outputs.core == 'true'
        run: |
          pip install --quiet cyclonedx-bom
          cyclonedx-py environment --of json --output-file sbom.json

      - name: Upload SBOM artefact
        if: needs.changes.outputs.core == 'true'
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

      # ─ SAST: Python static analysis ──────────────────────────────
      - name: bandit (Python SAST)
        if: needs.changes.outputs.core == 'true' || needs.changes.outputs.jobs == 'true'
        run: bandit -r src/ -ll -ii
        # -ll = medium+ severity, -ii = medium+ confidence
        # Accepted false positives are suppressed via .bandit (skip=B608)
        # and inline # nosec annotations. Failing this step blocks the PR.

      # ─ IaC: Terraform + Dockerfile misconfiguration ──────────────
      - name: checkov (Terraform IaC)
        if: needs.changes.outputs.infra == 'true'
        run: |
          checkov -d infrastructure/ \
            --framework terraform \
            --config-file .checkov.yml \
            --quiet
        # Accepted findings suppressed in .checkov.yml with documented rationale.
        # Failing this step blocks the PR.

      - name: checkov (Dockerfile)
        run: |
          checkov -f Dockerfile \
            --framework dockerfile \
            --config-file .checkov.yml \
            --quiet
