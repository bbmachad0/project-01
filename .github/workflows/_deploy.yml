# ─── Reusable Deploy Workflow ─────────────────────────────────────
# Contains all deployment logic. Called by deploy-dev/int/prod wrappers.
#
# Projects are auto-discovered from infrastructure/projects/*/project.json.
# Adding a new project requires no changes here - it is picked up automatically.
#
# Selective deployment:
#   - Baseline or shared modules changed → deploy ALL projects (they may be affected)
#   - Only project-specific files changed  → deploy ONLY the changed projects
#   - src/jobs or pyproject.toml changed   → deploy ALL projects (new scripts)
#
# Deploy order:
#   1. Baseline            (S3, IAM, Glue databases, VPC)
#   2. Artifacts           (foundation wheel from GitHub Releases + job scripts to S3)
#   3. Destroy Projects    (removed projects- terraform destroy from previous state)
#   4. Deploy Projects     (new/changed projects- terraform apply, in parallel)

name: _deploy

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: "Target environment (dev, int, prod)"
    secrets:
      AWS_ROLE_ARN:
        required: true

permissions:
  contents: read
  id-token: write

env:
  PYTHON_VERSION: "3.11"
  TERRAFORM_VERSION: "1.14.5"
  ENV: ${{ inputs.environment }}
  # Foundation library version - update when upgrading dp_foundation.
  FOUNDATION_VERSION: "1.0.0"
  FOUNDATION_REPO: "ORG/org-data-platform-foundation"
  # Injected into every Terraform apply as resource tags (for auditability).
  TF_VAR_git_sha:     ${{ github.sha }}
  TF_VAR_deployed_by: ${{ github.actor }}
  TF_VAR_repository:  ${{ github.repository }}

jobs:
  # ── Detect what changed ──────────────────────────────────────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      python:          ${{ steps.filter.outputs.python }}
      jobs:            ${{ steps.filter.outputs.jobs }}
      baseline_infra:  ${{ steps.filter.outputs.baseline_infra }}
      projects_infra:  ${{ steps.filter.outputs.projects_infra }}
      aws_region:      ${{ steps.domain.outputs.aws_region }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 2   # needed for git diff in discover step

      - name: Read domain.json
        id: domain
        run: echo "aws_region=$(jq -r .aws_region setup/domain.json)" >> "$GITHUB_OUTPUT"

      - name: Path filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36  # v3
        id: filter
        with:
          filters: |
            python:
              - 'pyproject.toml'
              - 'src/jobs/**'
              - 'tests/**'
            jobs:
              - 'src/jobs/**'
            baseline_infra:
              - 'infrastructure/baseline/**'
              - 'infrastructure/environments/**'
              - 'infrastructure/modules/**'
              - 'setup/domain.json'
            projects_infra:
              - 'infrastructure/projects/**'

  # ── Discover which projects to deploy ────────────────────────────
  # Logic:
  #   - src/jobs or pyproject.toml changed → ALL projects (new scripts / deps)
  #   - baseline/modules/envs changed      → ALL projects (shared infra changed)
  #   - only projects/** changed           → ONLY the projects whose files changed
  discover:
    name: Discover Projects
    needs: changes
    if: |
      needs.changes.outputs.python == 'true' ||
      needs.changes.outputs.jobs == 'true' ||
      needs.changes.outputs.baseline_infra == 'true' ||
      needs.changes.outputs.projects_infra == 'true'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.list.outputs.matrix }}
      removed_matrix: ${{ steps.removed.outputs.removed_matrix }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 2

      - name: Resolve project matrix
        id: list
        env:
          ALL_PROJECTS:    ${{ needs.changes.outputs.python == 'true' || needs.changes.outputs.jobs == 'true' || needs.changes.outputs.baseline_infra == 'true' }}
          PROJECTS_CHANGED: ${{ needs.changes.outputs.projects_infra }}
        run: |
          # All known projects
          ALL=$(find infrastructure/projects -maxdepth 2 -name 'project.json' \
            ! -path '*/_template/*' | sort | xargs -I{} dirname {} | xargs -I{} basename {})

          if [[ "$ALL_PROJECTS" == "true" ]]; then
            # Deploy everything (shared/src change)
            echo "Deploying ALL projects (shared change detected)"
            DEPLOY="$ALL"
          else
            # Only deploy projects whose directory changed
            CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD | grep '^infrastructure/projects/' \
              | sed 's|infrastructure/projects/||;s|/.*||' | sort -u | grep -v '^_template$')
            DEPLOY=$(comm -12 <(echo "$ALL") <(echo "$CHANGED_DIRS"))
            echo "Deploying CHANGED projects only: ${DEPLOY:-none}"
          fi

          MATRIX=$(echo "$DEPLOY" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix=${MATRIX}" >> "$GITHUB_OUTPUT"

      - name: Detect removed projects
        id: removed
        run: |
          # Projects that had project.json in the previous commit
          PREV=$(git ls-tree -r --name-only HEAD~1 -- infrastructure/projects/ 2>/dev/null \
            | grep '/project\.json$' | grep -v '_template/' \
            | sed 's|infrastructure/projects/||;s|/project\.json||' | sort) || true

          # Projects in the current commit
          CURR=$(find infrastructure/projects -maxdepth 2 -name 'project.json' \
            ! -path '*/_template/*' \
            | sed 's|infrastructure/projects/||;s|/project\.json||' | sort)

          # Removed = existed before but no longer present
          REMOVED=$(comm -23 <(echo "$PREV") <(echo "$CURR"))

          if [[ -n "$REMOVED" ]]; then
            echo "::warning::Removed projects detected- will run terraform destroy: $(echo $REMOVED | tr '\n' ' ')"
          else
            echo "No removed projects detected"
          fi

          MATRIX=$(echo "$REMOVED" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "removed_matrix=${MATRIX}" >> "$GITHUB_OUTPUT"

  # ── Deploy Baseline ──────────────────────────────────────────
  baseline:
    name: Deploy Baseline
    needs: changes
    if: |
      needs.changes.outputs.python == 'true' ||
      needs.changes.outputs.jobs == 'true' ||
      needs.changes.outputs.baseline_infra == 'true' ||
      needs.changes.outputs.projects_infra == 'true'
    runs-on: ubuntu-latest
    outputs:
      account_id: ${{ steps.aws.outputs.account_id }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a  # v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ needs.changes.outputs.aws_region }}

      - name: Resolve AWS Account ID
        id: aws
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "::add-mask::${ACCOUNT_ID}"
          echo "account_id=${ACCOUNT_ID}" >> "$GITHUB_OUTPUT"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: infrastructure/environments/${{ env.ENV }}
        run: |
          terraform init \
            -backend-config="bucket=tfstate-${{ steps.aws.outputs.account_id }}" \
            -backend-config="region=${{ needs.changes.outputs.aws_region }}" \
            -backend-config="use_lockfile=true"

      - name: Terraform Apply - Baseline
        working-directory: infrastructure/environments/${{ env.ENV }}
        run: |
          terraform plan -out=tfplan -input=false
          terraform apply -auto-approve tfplan

  # ── Upload Artifacts (foundation wheel + job scripts to S3) ────
  artifacts:
    name: Upload Artifacts
    needs: [changes, baseline]
    if: |
      needs.changes.outputs.python == 'true' ||
      needs.changes.outputs.jobs == 'true' ||
      needs.changes.outputs.baseline_infra == 'true' ||
      needs.changes.outputs.projects_infra == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a  # v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ needs.changes.outputs.aws_region }}

      - name: Resolve AWS Account ID
        id: aws
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "::add-mask::${ACCOUNT_ID}"
          echo "account_id=${ACCOUNT_ID}" >> "$GITHUB_OUTPUT"

      - name: Download and upload foundation wheel
        run: |
          ABBR=$(jq -r .domain_abbr setup/domain.json)
          CC=$(jq -r .country_code setup/domain.json)
          ACCOUNT_ID="${{ steps.aws.outputs.account_id }}"
          WHEEL_NAME="data_platform_foundation-${{ env.FOUNDATION_VERSION }}-py3-none-any.whl"
          # Download the foundation wheel from GitHub Releases
          curl -fsSL -o "${WHEEL_NAME}" \
            "https://github.com/${{ env.FOUNDATION_REPO }}/releases/download/v${{ env.FOUNDATION_VERSION }}/${WHEEL_NAME}"
          # Upload to the domain's S3 artifacts bucket
          aws s3 cp "${WHEEL_NAME}" \
            "s3://${ABBR}-artifacts-${ACCOUNT_ID}-${CC}-${{ env.ENV }}/wheels/${WHEEL_NAME}"

      - name: Upload job scripts
        if: needs.changes.outputs.jobs == 'true'
        run: |
          ABBR=$(jq -r .domain_abbr setup/domain.json)
          CC=$(jq -r .country_code setup/domain.json)
          ACCOUNT_ID="${{ steps.aws.outputs.account_id }}"
          aws s3 sync src/jobs/ \
            "s3://${ABBR}-artifacts-${ACCOUNT_ID}-${CC}-${{ env.ENV }}/jobs/" \
            --delete --exact-timestamps

  # ── Destroy Removed Projects ───────────────────────────────────
  # When a project directory is deleted from the repo, this job
  # recovers the Terraform files from the previous commit (HEAD~1)
  # and runs `terraform destroy` to tear down the project's AWS
  # resources.  This guarantees the CI/CD pipeline is the single
  # source of truth for ALL cloud mutations- including teardown.
  destroy-projects:
    name: "Destroy › ${{ matrix.project }}"
    needs: [changes, baseline, discover]
    if: needs.discover.outputs.removed_matrix != '[]' && needs.discover.outputs.removed_matrix != ''
    strategy:
      matrix:
        project: ${{ fromJson(needs.discover.outputs.removed_matrix) }}
      fail-fast: false
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4
        with:
          fetch-depth: 2

      - name: Restore project files from previous commit
        run: |
          echo "Restoring infrastructure/projects/${{ matrix.project }}/ from HEAD~1"
          git checkout HEAD~1 -- "infrastructure/projects/${{ matrix.project }}/"

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a  # v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ needs.changes.outputs.aws_region }}

      - name: Resolve AWS Account ID
        id: aws
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "::add-mask::${ACCOUNT_ID}"
          echo "account_id=${ACCOUNT_ID}" >> "$GITHUB_OUTPUT"

      - name: Read project name from restored files
        id: project
        run: |
          SLUG=$(jq -r .name "infrastructure/projects/${{ matrix.project }}/project.json")
          echo "name=${SLUG}" >> "$GITHUB_OUTPUT"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: infrastructure/projects/${{ matrix.project }}
        run: |
          terraform init \
            -backend-config="bucket=tfstate-${{ steps.aws.outputs.account_id }}" \
            -backend-config="key=projects/${{ steps.project.outputs.name }}/terraform.tfstate" \
            -backend-config="region=${{ needs.changes.outputs.aws_region }}" \
            -backend-config="use_lockfile=true"

      - name: Terraform Destroy
        working-directory: infrastructure/projects/${{ matrix.project }}
        run: |
          echo "::warning::Destroying all resources for project '${{ matrix.project }}' (${{ steps.project.outputs.name }})"
          terraform plan -destroy -var="environment=${{ env.ENV }}" -out=tfplan -input=false
          terraform apply -auto-approve tfplan

  # ── Deploy Projects (selective, parallel) ────────────────────────
  deploy-projects:
    name: "Deploy › ${{ matrix.project }}"
    needs: [changes, baseline, artifacts, discover]
    if: needs.discover.outputs.matrix != '[]' && needs.discover.outputs.matrix != ''
    strategy:
      matrix:
        project: ${{ fromJson(needs.discover.outputs.matrix) }}
      fail-fast: false   # other projects continue if one fails
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a  # v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ needs.changes.outputs.aws_region }}

      - name: Resolve AWS Account ID
        id: aws
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "::add-mask::${ACCOUNT_ID}"
          echo "account_id=${ACCOUNT_ID}" >> "$GITHUB_OUTPUT"

      - name: Read project name
        id: project
        run: |
          SLUG=$(jq -r .name infrastructure/projects/${{ matrix.project }}/project.json)
          echo "name=${SLUG}" >> "$GITHUB_OUTPUT"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: infrastructure/projects/${{ matrix.project }}
        run: |
          terraform init \
            -backend-config="bucket=tfstate-${{ steps.aws.outputs.account_id }}" \
            -backend-config="key=projects/${{ steps.project.outputs.name }}/terraform.tfstate" \
            -backend-config="region=${{ needs.changes.outputs.aws_region }}" \
            -backend-config="use_lockfile=true"

      - name: Terraform Apply
        working-directory: infrastructure/projects/${{ matrix.project }}
        run: |
          terraform plan -var="environment=${{ env.ENV }}" -out=tfplan -input=false
          terraform apply -auto-approve tfplan
