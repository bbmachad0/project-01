# ─── Deploy to Int ────────────────────────────────────────────────
# Triggered on push to the `int` branch.
# Uses path filters to skip unnecessary steps.
# All config read from domain.json - no hardcoded project names.

name: Deploy - Int

on:
  push:
    branches: [int]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - "docs/**"

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-int
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.11"
  TERRAFORM_VERSION: "1.14.5"

jobs:
  # ── Detect what changed ──────────────────────────────────────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      jobs: ${{ steps.filter.outputs.jobs }}
      infra: ${{ steps.filter.outputs.infra }}
      domain_abbr: ${{ steps.domain.outputs.domain_abbr }}
      aws_region: ${{ steps.domain.outputs.aws_region }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read domain.json
        id: domain
        run: |
          echo "domain_abbr=$(jq -r .domain_abbr domain.json)" >> "$GITHUB_OUTPUT"
          echo "aws_region=$(jq -r .aws_region domain.json)" >> "$GITHUB_OUTPUT"

      - name: Path filter
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'src/core/**'
              - 'pyproject.toml'
            jobs:
              - 'src/jobs/**'
            infra:
              - 'infrastructure/**'
              - 'domain.json'

  # ── Deploy ───────────────────────────────────────────────────────
  deploy:
    name: Deploy to Int
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.jobs == 'true' || needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    env:
      ABBR: ${{ needs.changes.outputs.domain_abbr }}
      ENV: int
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_INT }}
          aws-region: ${{ needs.changes.outputs.aws_region }}

      # ── Terraform (runs first to create infrastructure) ──────────
      - name: Setup Terraform
        if: needs.changes.outputs.infra == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Ensure tfstate bucket
        if: needs.changes.outputs.infra == 'true'
        run: |
          BUCKET="${ABBR}-tfstate-${ENV}"
          if ! aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "Creating backend bucket: $BUCKET"
            aws s3api create-bucket --bucket "$BUCKET" \
              --region "$AWS_REGION" \
              --create-bucket-configuration LocationConstraint="$AWS_REGION"
            aws s3api put-bucket-versioning --bucket "$BUCKET" \
              --versioning-configuration Status=Enabled
            aws s3api put-public-access-block --bucket "$BUCKET" \
              --public-access-block-configuration \
              BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true
          else
            echo "Backend bucket already exists: $BUCKET"
          fi

      - name: Terraform Init
        if: needs.changes.outputs.infra == 'true'
        working-directory: infrastructure/environments/${{ env.ENV }}
        run: terraform init -backend-config=backend.conf

      - name: Terraform Plan
        if: needs.changes.outputs.infra == 'true'
        working-directory: infrastructure/environments/${{ env.ENV }}
        run: terraform plan -out=tfplan -input=false

      - name: Terraform Apply
        if: needs.changes.outputs.infra == 'true'
        working-directory: infrastructure/environments/${{ env.ENV }}
        run: terraform apply -auto-approve tfplan

      # ── Build & Upload Wheel (only when core changed) ────────────
      - name: Setup Python
        if: needs.changes.outputs.core == 'true' || needs.changes.outputs.jobs == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build wheel
        if: needs.changes.outputs.core == 'true'
        run: |
          pip install build
          python -m build --wheel --outdir dist/

      - name: Upload wheel to S3
        if: needs.changes.outputs.core == 'true'
        run: |
          WHEEL=$(ls dist/*.whl | head -1)
          aws s3 cp "$WHEEL" \
            "s3://${ABBR}-artifacts-${ENV}/wheels/core-latest-py3-none-any.whl"

      # ── Upload Job Scripts (only when jobs changed) ──────────────
      - name: Upload job scripts to S3
        if: needs.changes.outputs.jobs == 'true'
        run: |
          aws s3 sync src/jobs/ \
            "s3://${ABBR}-artifacts-${ENV}/jobs/" \
            --delete --exact-timestamps
