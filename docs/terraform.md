# Terraform

## Overview

All infrastructure is defined in `infrastructure/` using Terraform with the
AWS provider. The structure follows a layered approach: **baseline** for
shared resources, **projects** for domain-specific stacks, and **environments**
as the root modules that compose everything together.

---

## Directory Layout

```
infrastructure/
├── modules/                     # Reusable primitives
│   ├── glue_job/
│   ├── iam_glue_job/
│   ├── glue_catalog_database/
│   ├── glue_catalog_table/
│   ├── glue_table_optimizer/
│   ├── iam_table_optimizer/
│   ├── stepfunction_pipeline/
│   ├── iam_role/
│   └── s3_bucket/
├── baseline/                   # Shared infra
│   ├── main.tf
│   ├── s3.tf
│   ├── iam.tf
│   ├── glue_databases.tf
│   ├── variables.tf
│   └── outputs.tf
├── projects/                    # Per-project stacks
│   ├── main.tf                  # Aggregator - wires all projects
│   ├── variables.tf
│   ├── _template/               # Copy to create a new project
│   ├── sales/
│   ├── customers/
│   └── legacy_refactor/
└── environments/                # Root modules (one per env)
    ├── dev/
    │   ├── main.tf
    │   ├── backend.tf
    │   └── backend.conf         # Generated by setup/init-terraform.sh
    ├── int/
    └── prod/
```

---

## Module Hierarchy

```
environments/<env>/main.tf
  ├── module "baseline"    → baseline/
  └── module "projects"      → projects/main.tf
        ├── module "sales"        → projects/sales/
        ├── module "customers"    → projects/customers/
        └── module "legacy"       → projects/legacy_refactor/
              └── module "job_*"    → modules/glue_job/
              └── module "table_*"  → modules/glue_catalog_table/
              └── ...
```

---

## Baseline Layer

Shared across all projects within the domain:

| Resource | Naming | Notes |
|----------|--------|-------|
| S3 buckets | `{abbr}-{purpose}-{account_id}-{country_code}-{env}` | raw, refined, curated, artifacts |
| Glue databases | `{abbr}_{country_code}_{layer}` | raw, refined, curated |
| IAM base roles | `{abbr}-glue-base-{env}` | Common permissions |

---

## Projects Layer

Each project is a self-contained directory with:

| File | Purpose |
|------|---------|
| `variables.tf` | Inputs: env, domain_abbr, project_name, bucket names |
| `tables.tf` | Glue Catalog tables (Standard in RAW, Iceberg elsewhere) |
| `jobs.tf` | Glue Job definitions using `modules/glue_job` |
| `optimizers.tf` | Table optimizers (compaction, orphan, retention) |
| `pipelines.tf` | StepFunctions pipeline |
| `outputs.tf` | Exports for cross-project references |

The aggregator (`projects/main.tf`) passes each project a unique
`project_name` that becomes part of every resource name.

---

## Backend Configuration

State is stored in S3 with DynamoDB locking. Backend configuration is
**partial** - the bucket, key, and region are injected via `backend.conf`:

```hcl
# backend.tf (checked in)
terraform {
  backend "s3" {}
}
```

```ini
# backend.conf (generated, git-ignored)
bucket         = "tfstate-390403879405"
region         = "eu-west-1"
use_lockfile   = true
```

Generate these files with:

```bash
./setup/init-terraform.sh
```

---

## Common Commands

```bash
make terraform-init-dev       # terraform init with backend.conf
make terraform-plan-dev       # plan against dev
make terraform-plan-int
make terraform-plan-prod
```

---

## Adding Modules

Reusable modules live in `infrastructure/modules/`. Each module has:

- `main.tf` - resource definitions
- `variables.tf` - input variables
- `outputs.tf` - exported values

Modules are referenced by projects via relative paths:

```hcl
module "job_daily_sales" {
  source = "../../modules/glue_job"
  # ...
}
```
