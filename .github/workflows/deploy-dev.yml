# ─── Deploy to Dev ────────────────────────────────────────────────
# Triggered on push to the `dev` branch.
# Uses path filters to skip unnecessary steps.
# All config read from domain.json - no hardcoded project names.

name: Deploy - Dev

on:
  push:
    branches: [dev]
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - "docs/**"

permissions:
  contents: read
  id-token: write

concurrency:
  group: deploy-dev
  cancel-in-progress: false

env:
  PYTHON_VERSION: "3.11"
  TERRAFORM_VERSION: "1.14.5"

jobs:
  # ── Detect what changed ──────────────────────────────────────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      core: ${{ steps.filter.outputs.core }}
      jobs: ${{ steps.filter.outputs.jobs }}
      infra: ${{ steps.filter.outputs.infra }}
      domain_abbr: ${{ steps.domain.outputs.domain_abbr }}
      aws_region: ${{ steps.domain.outputs.aws_region }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Read domain.json
        id: domain
        run: |
          echo "domain_abbr=$(jq -r .domain_abbr domain.json)" >> "$GITHUB_OUTPUT"
          echo "aws_region=$(jq -r .aws_region domain.json)" >> "$GITHUB_OUTPUT"

      - name: Path filter
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'src/core/**'
              - 'pyproject.toml'
            jobs:
              - 'src/jobs/**'
            infra:
              - 'infrastructure/**'
              - 'domain.json'

  # ── Deploy ───────────────────────────────────────────────────────
  deploy:
    name: Deploy to Dev
    needs: changes
    if: needs.changes.outputs.core == 'true' || needs.changes.outputs.jobs == 'true' || needs.changes.outputs.infra == 'true'
    runs-on: ubuntu-latest
    env:
      ABBR: ${{ needs.changes.outputs.domain_abbr }}
      ENV: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ needs.changes.outputs.aws_region }}

      # ── Terraform (runs first to create infrastructure) ──────────
      - name: Setup Terraform
        if: needs.changes.outputs.infra == 'true'
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        if: needs.changes.outputs.infra == 'true'
        working-directory: infrastructure/environments/${{ env.ENV }}
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          REGION=$(jq -r .aws_region "$GITHUB_WORKSPACE/domain.json")
          terraform init \
            -backend-config="bucket=tfstate-${ACCOUNT_ID}-${ENV}" \
            -backend-config="region=${REGION}" \
            -backend-config="use_lockfile=true"

      - name: Terraform Plan
        if: needs.changes.outputs.infra == 'true'
        working-directory: infrastructure/environments/${{ env.ENV }}
        run: terraform plan -out=tfplan -input=false

      - name: Terraform Apply
        if: needs.changes.outputs.infra == 'true'
        working-directory: infrastructure/environments/${{ env.ENV }}
        run: terraform apply -auto-approve tfplan

      # ── Build & Upload Wheel (only when core changed) ────────────
      - name: Setup Python
        if: needs.changes.outputs.core == 'true' || needs.changes.outputs.jobs == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Build wheel
        if: needs.changes.outputs.core == 'true'
        run: |
          pip install build
          python -m build --wheel --outdir dist/

      - name: Upload wheel to S3
        if: needs.changes.outputs.core == 'true'
        run: |
          WHEEL=$(ls dist/*.whl | head -1)
          aws s3 cp "$WHEEL" \
            "s3://${ABBR}-artifacts-${ENV}/wheels/core-latest-py3-none-any.whl"

      # ── Upload Job Scripts (only when jobs changed) ──────────────
      - name: Upload job scripts to S3
        if: needs.changes.outputs.jobs == 'true'
        run: |
          aws s3 sync src/jobs/ \
            "s3://${ABBR}-artifacts-${ENV}/jobs/" \
            --delete --exact-timestamps
