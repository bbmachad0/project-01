# ─── Terraform Plan on Pull Request ──────────────────────────────
# Runs terraform plan for foundation + all auto-discovered projects
# when infra files change, then posts a combined sticky PR comment.
#
# No hardcoded project names - projects discovered automatically from
# infrastructure/projects/*/project.json.
#
# Requires: AWS_ROLE_ARN_DEV, AWS_ROLE_ARN_INT, AWS_ROLE_ARN_PROD

name: Terraform Plan (PR)

on:
  pull_request:
    branches: [dev, int, main]
    paths:
      - "infrastructure/**"
      - "setup/domain.json"

permissions:
  contents: read
  id-token: write
  pull-requests: write

concurrency:
  group: tf-plan-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  TERRAFORM_VERSION: "1.14.5"

jobs:
  plan:
    name: Plan (${{ github.base_ref }})
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5  # v4

      # ── Derive environment from target branch ─────────────────
      - name: Set environment
        id: env
        run: |
          case "${{ github.base_ref }}" in
            dev)  echo "name=dev"  >> "$GITHUB_OUTPUT" ;;
            int)  echo "name=int"  >> "$GITHUB_OUTPUT" ;;
            main) echo "name=prod" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Read domain config
        id: domain
        run: echo "aws_region=$(jq -r .aws_region setup/domain.json)" >> "$GITHUB_OUTPUT"

      # ── AWS authentication ─────────────────────────────────────
      - name: Resolve AWS role ARN
        id: role
        env:
          ROLE_DEV:  ${{ secrets.AWS_ROLE_ARN_DEV }}
          ROLE_INT:  ${{ secrets.AWS_ROLE_ARN_INT }}
          ROLE_PROD: ${{ secrets.AWS_ROLE_ARN_PROD }}
        run: |
          case "${{ steps.env.outputs.name }}" in
            dev)  echo "arn=${ROLE_DEV}"  >> "$GITHUB_OUTPUT" ;;
            int)  echo "arn=${ROLE_INT}"  >> "$GITHUB_OUTPUT" ;;
            prod) echo "arn=${ROLE_PROD}" >> "$GITHUB_OUTPUT" ;;
          esac

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@7474bc4690e29a8392af63c5b98e7449536d5c3a  # v4
        with:
          role-to-assume: ${{ steps.role.outputs.arn }}
          aws-region: ${{ steps.domain.outputs.aws_region }}

      - name: Resolve AWS Account ID
        id: aws
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "::add-mask::${ACCOUNT_ID}"
          echo "account_id=${ACCOUNT_ID}" >> "$GITHUB_OUTPUT"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@b9cd54a3c349d3f38e8881555d616ced269862dd  # v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      # ── Plan Foundation ────────────────────────────────────────
      - name: Plan Foundation
        id: plan-foundation
        env:
          ENV:        ${{ steps.env.outputs.name }}
          ACCOUNT_ID: ${{ steps.aws.outputs.account_id }}
          REGION:     ${{ steps.domain.outputs.aws_region }}
        run: |
          set +e
          terraform -chdir="infrastructure/environments/${ENV}" init \
            -backend-config="bucket=tfstate-${ACCOUNT_ID}" \
            -backend-config="region=${REGION}" \
            -backend-config="use_lockfile=true" -input=false -no-color > /dev/null 2>&1
          terraform -chdir="infrastructure/environments/${ENV}" plan \
            -no-color -input=false 2>&1 > /tmp/plan-foundation.txt
          echo "exit_code=${PIPESTATUS[0]}" >> "$GITHUB_OUTPUT"
          set -e
        continue-on-error: true

      # ── Discover Projects ──────────────────────────────────────
      - name: Discover project directories
        id: discover
        run: |
          PROJECTS=$(find infrastructure/projects -maxdepth 2 -name 'project.json' \
            ! -path '*/_template/*' | sort | xargs -I{} dirname {} | xargs -I{} basename {})
          echo "projects<<EOF" >> "$GITHUB_OUTPUT"
          echo "$PROJECTS"    >> "$GITHUB_OUTPUT"
          echo "EOF"          >> "$GITHUB_OUTPUT"

      # ── Plan each project (sequential to allow comment aggregation) ─
      - name: Plan Projects
        id: plan-projects
        env:
          ENV:        ${{ steps.env.outputs.name }}
          ACCOUNT_ID: ${{ steps.aws.outputs.account_id }}
          REGION:     ${{ steps.domain.outputs.aws_region }}
          PROJECTS:   ${{ steps.discover.outputs.projects }}
        run: |
          set +e
          echo "" > /tmp/plan-projects.txt
          OVERALL_EXIT=0
          while IFS= read -r PROJECT; do
            [[ -z "$PROJECT" ]] && continue
            SLUG=$(jq -r .slug "infrastructure/projects/${PROJECT}/project.json")
            echo "=== Project: ${PROJECT} (slug: ${SLUG}) ===" >> /tmp/plan-projects.txt
            terraform -chdir="infrastructure/projects/${PROJECT}" init \
              -backend-config="bucket=tfstate-${ACCOUNT_ID}" \
              -backend-config="key=projects/${SLUG}/terraform.tfstate" \
              -backend-config="region=${REGION}" \
              -backend-config="use_lockfile=true" -input=false -no-color > /dev/null 2>&1
            terraform -chdir="infrastructure/projects/${PROJECT}" plan \
              -var="environment=${ENV}" -no-color -input=false 2>&1 >> /tmp/plan-projects.txt
            [[ ${PIPESTATUS[0]} -ne 0 ]] && OVERALL_EXIT=1
            echo "" >> /tmp/plan-projects.txt
          done <<< "$PROJECTS"
          echo "exit_code=${OVERALL_EXIT}" >> "$GITHUB_OUTPUT"
          set -e
        continue-on-error: true

      # ── Post combined PR comment ───────────────────────────────
      - name: Post plan comment
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b  # v7
        env:
          ENV_NAME:          ${{ steps.env.outputs.name }}
          FOUNDATION_EXIT:   ${{ steps.plan-foundation.outputs.exit_code }}
          PROJECTS_EXIT:     ${{ steps.plan-projects.outputs.exit_code }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const env         = process.env.ENV_NAME;
            const fExit       = process.env.FOUNDATION_EXIT;
            const pExit       = process.env.PROJECTS_EXIT;
            const overallOk   = fExit === '0' && pExit === '0';
            const status      = overallOk ? '✅' : '❌';
            const planFoundation = fs.readFileSync('/tmp/plan-foundation.txt', 'utf8');
            const planProjects   = fs.readFileSync('/tmp/plan-projects.txt',   'utf8');

            const body = [
              `<!-- tf-plan-${env} -->`,
              `### ${status} Terraform Plan - \`${env}\``,
              '',
              `<details><summary>Foundation</summary>`,
              '',
              '```hcl',
              planFoundation,
              '```',
              '</details>',
              '',
              `<details><summary>Projects</summary>`,
              '',
              '```',
              planProjects,
              '```',
              '</details>',
              '',
              `*@${{ github.actor }} · \`${{ github.head_ref }}\` → \`${{ github.base_ref }}\`*`,
            ].join('\n');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const marker   = `<!-- tf-plan-${env} -->`;
            const existing = comments.find(c => c.body && c.body.startsWith(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner, repo: context.repo.repo,
                comment_id: existing.id, body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner, repo: context.repo.repo,
                issue_number: context.issue.number, body,
              });
            }

      - name: Fail if any plan failed
        if: steps.plan-foundation.outputs.exit_code != '0' || steps.plan-projects.outputs.exit_code != '0'
        run: exit 1
